@page "/tours"
@using TournoiSalade.Data
@using Radzen
@inject ITournament CurrentTournament
@inject DialogService DialogServices

<PageTitle>Tours</PageTitle>

<h1>Tour @CurrentTournament.TourNumber</h1>

<RadzenButton Click=@(args => NewRound()) Text="Nouveau tour" Disabled="@CannotNewRound()" Icon="add_circle_outline" ButtonStyle="ButtonStyle.Success" />
<RadzenButton Click=@(args => CloseRound()) Text="Terminer tour" Disabled="@CannotCloseRound()" Icon="report" ButtonStyle="ButtonStyle.Danger" />

<br />
<br />

<RadzenDataGrid AllowFiltering="false" AllowPaging="false" PageSize="100" AllowSorting="false" Data="@CurrentTournament.CurrentTour.ExcludedPlayers" TItem="Player">
    <Columns>
        <RadzenDataGridColumn TItem="Player" Title="Joueur ne participant pas à ce tour">
            <Template Context="data">
                @data.Name
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

<br />
<br />

<RadzenDataGrid @ref="matchGrid" AllowFiltering="false" AllowPaging="false" PageSize="100" AllowSorting="false" Data="@CurrentTournament.CurrentTour.Matches" TItem="Match">
    <Columns>
        <RadzenDataGridColumn TItem="Match" Title="Team1">
            <Template Context="data">
                @data.Team1.Player1.Name - @data.Team1.Player2.Name
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Match" Title="Score Team1">
            <Template Context="data">
                <RadzenNumeric @bind-Value=@data.Team1Result TValue="int" Min="0" Max="8" Change=@OnChange />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Match" Title="Score Team2">
            <Template Context="data">
                <RadzenNumeric @bind-Value=@data.Team2Result TValue="int" Min="0" Max="8" Change=@OnChange />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="Match" Title="Team2">
            <Template Context="data">
                @data.Team2.Player1.Name - @data.Team2.Player2.Name
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    RadzenDataGrid<Match> matchGrid;
    bool CloseDisabled;

    private async Task NewRound()
    {
        var yes = await DialogServices.Confirm("On commence un nouveau tour ?", "Nouveau tour", new ConfirmOptions() { OkButtonText = "Oui", CancelButtonText = "Non" });

        if (yes.HasValue && yes.Value)
        {
            await CurrentTournament.NextTour();
            CloseDisabled = false;
            await matchGrid.Reload();
        }
    }

    private async Task CloseRound()
    {
        var yes = await DialogServices.Confirm("On termine le tour ?", "Fermeture tour", new ConfirmOptions() { OkButtonText = "Oui", CancelButtonText = "Non" });

        if (yes.HasValue && yes.Value)
        {
            // Compute all player scores
            CurrentTournament.ComputePlayerPoints();
            CurrentTournament.NextTour();
            this.StateHasChanged();
        }
    }

    bool CannotCloseRound()
    {
        return !CurrentTournament.CurrentTour.AllMatchHaveResult() || CannotNewRound();
    }

    bool CannotNewRound()
    {
        return CurrentTournament.Players.Count < 4;
    }

    void OnChange()
    {
        CurrentTournament.Save();
        this.StateHasChanged();
    }
}

